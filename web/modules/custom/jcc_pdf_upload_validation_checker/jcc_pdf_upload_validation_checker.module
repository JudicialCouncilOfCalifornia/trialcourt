<?php

/**
 * @file
 * Primary module hooks for JCC PDF upload validation checker module.
 *
 * @DCG
 * This file is no longer required in Drupal 8.
 * @see https://www.drupal.org/node/2217931
 */

use Drupal\Core\Entity\EntityInterface;

/**
 * Implements hook_entity_insert().
 */
function jcc_pdf_upload_validation_checker_entity_insert(EntityInterface $entity) {
  _jcc_pdf_upload_validation_checker_queue($entity);
}

/**
 * Implements hook_entity_update().
 */
function jcc_pdf_upload_validation_checker_entity_update(EntityInterface $entity) {
  _jcc_pdf_upload_validation_checker_queue($entity);
}

/**
 * Look for file references on nodes/media and queue PDF files.
 */
function _jcc_pdf_upload_validation_checker_queue(EntityInterface $entity): void {
  $type = $entity->getEntityTypeId();
  if (!in_array($type, ['node', 'media'], TRUE)) {
    return;
  }

  $queue = \Drupal::queue('jcc_pdf_upload_validation_checker_pdf_audit');

  // Scan all fields and enqueue any referenced file entities.
  foreach ($entity->getFieldDefinitions() as $field_name => $def) {
    if (!$entity->hasField($field_name)) {
      continue;
    }

    $field = $entity->get($field_name);
    if ($field->isEmpty()) {
      continue;
    }

    // Only entity references to files.
    $settings = $def->getSettings();
    if (($settings['target_type'] ?? NULL) !== 'file') {
      continue;
    }

    foreach ($field as $item) {
      $fid = (int) $item->target_id;
      if (!$fid) {
        continue;
      }

      $file = \Drupal::entityTypeManager()->getStorage('file')->load($fid);
      if (!$file || $file->getMimeType() !== 'application/pdf') {
        continue;
      }

      // Set pending if field exists.
      if ($file->hasField('field_pdf_audit_status')) {
        $file->set('field_pdf_audit_status', 'pending');
        $file->save();
      }

      // Don’t queue temp files.
      if ($file->isTemporary()) {
        continue;
      }

      // If already processed, don’t requeue.
      if ($file->hasField('field_pdf_audit_status')) {
        $status = (string) $file->get('field_pdf_audit_status')->value;
        if (in_array($status, ['pass', 'fail'], TRUE)) {
          continue;
        }
      }

      $queue->createItem(['fid' => $fid]);
      \Drupal::logger('jcc_pdf_upload_validation_checker')->notice('Queued PDF audit for fid=@fid', ['@fid' => $fid]);
    }
  }
}
